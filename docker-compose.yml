services:
    nginx:
        image: nginx:1.27-alpine
        container_name: app-nginx
        ports:
            - "8000:80"
        volumes:
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
            - ./:/var/www:ro
        depends_on:
            - backend
            - frontend

    backend:
        build:
            context: .
            dockerfile: ./docker/backend/Dockerfile
        container_name: app-backend
        working_dir: /var/www/backend
        environment:
            SESSION_LIFETIME: 720
        volumes:
            - ./:/var/www:delegated
            - backend_vendor:/var/www/backend/vendor
            - backend_storage:/var/www/backend/storage
            - backend_bootstrap_cache:/var/www/backend/bootstrap/cache
        depends_on:
            - db

    frontend:
        image: node:20-alpine
        container_name: app-frontend
        working_dir: /var/www/frontend
        volumes:
            - ./frontend:/var/www/frontend:delegated
            - frontend_node_modules:/var/www/frontend/node_modules
        command: sh -lc "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
        environment:
            - CHOKIDAR_USEPOLLING=true
        ports:
            - "5173:5173"

    db:
        image: mysql:8.0
        container_name: app-db
        ports:
            - "3306:3306"
        environment:
            MYSQL_DATABASE: app
            MYSQL_USER: app_user
            MYSQL_PASSWORD: password
            MYSQL_ROOT_PASSWORD: root_password
        volumes:
            - db-data:/var/lib/mysql
            - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro

    e2e:
        image: mcr.microsoft.com/playwright:v1.57.0-jammy
        container_name: app-e2e
        working_dir: /work
        volumes:
            - ./frontend:/work
            - frontend_node_modules:/work/node_modules
        depends_on:
            - nginx
            - backend
            - frontend
        command: sh -lc "if [ ! -d node_modules ]; then npm ci; fi && npm run e2e"

volumes:
    db-data:
    backend_vendor:
    backend_storage:
    backend_bootstrap_cache:
    frontend_node_modules:
